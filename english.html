<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Language Tutor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="bg-white rounded-xl shadow-lg p-6 w-full max-w-2xl mx-auto">
        <div id="alert-box" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-4" role="alert">
            <span id="alert-message"></span>
        </div>

        <h1 class="text-3xl font-bold text-center mb-6 text-gray-800">English Language Tutor</h1>

        <p class="text-gray-600 text-center mb-6">Type your sentences below and click "Correct" to get an improved version.  </p>

        <div class="mb-4">
            <label for="input-text" class="block text-gray-700 font-medium mb-2">Your Sentences:</label>
            <textarea id="input-text" rows="8" class="w-full p-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" placeholder="e.g., I going to the park, to play with dog."></textarea>
        </div>

        <div class="flex flex-col md:flex-row space-y-2 md:space-y-0 md:space-x-2">
            <button id="correct-button" class="w-full md:w-1/2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                Correct My Sentences
            </button>
            <button id="clear-button" class="w-full md:w-1/2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2">
                Clear Text
            </button>
        </div>
       
        <div id="loading-spinner" class="mt-4 text-center hidden">
            <div class="animate-spin inline-block w-8 h-8 border-4 border-gray-400 border-t-blue-500 rounded-full"></div>
            <p class="mt-2 text-sm text-gray-500">Correcting...</p>
        </div>

        <div id="result-container" class="mt-6 hidden">
            <div class="flex flex-col md:flex-row md:space-x-4 space-y-4 md:space-y-0">
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Original Text:</h2>
                    <div id="original-text" class="bg-gray-100 p-4 rounded-lg border border-gray-300 whitespace-pre-wrap"></div>
                </div>
                <div class="flex-1">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Corrected Text:</h2>
                    <div id="corrected-text" class="bg-gray-100 p-4 rounded-lg border border-gray-300 whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const inputText = document.getElementById('input-text');
        const correctButton = document.getElementById('correct-button');
        const clearButton = document.getElementById('clear-button');
        const loadingSpinner = document.getElementById('loading-spinner');
        const resultContainer = document.getElementById('result-container');
        const originalText = document.getElementById('original-text');
        const correctedText = document.getElementById('corrected-text');
        const alertBox = document.getElementById('alert-box');
        const alertMessage = document.getElementById('alert-message');

        const showMessage = (message, isError = false) => {
            alertMessage.textContent = message;
            alertBox.classList.remove('hidden');
            if (isError) {
                alertBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700');
                alertBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            } else {
                alertBox.classList.remove('bg-red-100', 'border-red-400', 'text-red-700');
                alertBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
            }
        };

        const hideMessage = () => {
            alertBox.classList.add('hidden');
        };

        const showLoading = () => {
            loadingSpinner.classList.remove('hidden');
            correctButton.disabled = true;
            correctButton.textContent = 'Correcting...';
            hideMessage();
        };

        const hideLoading = () => {
            loadingSpinner.classList.add('hidden');
            correctButton.disabled = false;
            correctButton.textContent = 'Correct My Sentences';
        };
       
        const clearAllText = () => {
            inputText.value = '';
            originalText.textContent = '';
            correctedText.textContent = '';
            resultContainer.classList.add('hidden');
            hideMessage();
        };

        correctButton.addEventListener('click', async () => {
            const textToCorrect = inputText.value.trim();
            if (!textToCorrect) {
                showMessage('Please enter some text to correct.', true);
                return;
            }

            showLoading();
            resultContainer.classList.add('hidden');

            const apiKey = ""; // Canvas will provide this at runtime
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            const systemPrompt = "You are a world-class English language tutor. Your task is to correct any grammatical errors, spelling mistakes, and awkward phrasing in the provided English text. Do not change the meaning. Present the corrected version clearly, without any conversational preamble or extra commentary.";

            const payload = {
                contents: [{ parts: [{ text: textToCorrect }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            let retries = 0;
            const maxRetries = 3;
            const delay = (ms) => new Promise(res => setTimeout(res, ms));

            const makeApiCall = async () => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retries < maxRetries) {
                            retries++;
                            const backoffDelay = Math.pow(2, retries) * 1000;
                            console.log(`Rate limit exceeded, retrying in ${backoffDelay}ms...`);
                            await delay(backoffDelay);
                            return await makeApiCall(); // Recursive call with backoff
                        }
                        const errorData = await response.json();
                        throw new Error(`API error: ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    const correctedTextContent = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (correctedTextContent) {
                        originalText.textContent = textToCorrect;
                        correctedText.textContent = correctedTextContent.trim();
                        resultContainer.classList.remove('hidden');
                    } else {
                        showMessage('Could not get a valid correction. Please try again.', true);
                    }
                } catch (error) {
                    console.error('Error during API call:', error);
                    showMessage(`An error occurred: ${error.message}`, true);
                } finally {
                    hideLoading();
                }
            };

            await makeApiCall();
        });

        clearButton.addEventListener('click', clearAllText);
    </script>
</body>
</html>


